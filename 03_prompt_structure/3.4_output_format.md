## 3.4 输出格式的定义与约束

输出格式的明确定义是提示词工程的重要环节。清晰的格式约束不仅使输出更易于使用和解析，还能提高输出的一致性和可预测性。本节将介绍如何有效地定义和约束模型的输出格式。

### 3.4.1 为什么输出格式很重要

#### 提高可用性

结构化的输出可以直接用于后续处理：

```
非结构化输出：
这款产品评价不错，用户普遍反馈质量好，价格合理，
物流快速，但也有少数人提到包装简陋。

结构化输出：
{
  "overall_rating": 4.2,
  "positive_aspects": ["质量好", "价格合理", "物流快速"],
  "negative_aspects": ["包装简陋"],
  "recommendation": true
}
```

#### 确保一致性

格式约束使多次调用产生一致的输出结构，便于批量处理和比较。

#### 便于集成

API 调用场景中，结构化输出可以被程序直接解析和使用。

### 3.4.2 常见输出格式类型

#### 1. JSON 格式

最常用的结构化输出格式，便于程序解析。

```
请以 JSON 格式输出分析结果：
{
  "category": "产品类别",
  "sentiment": "positive/negative/neutral",
  "score": 0-10的数值,
  "keywords": ["关键词列表"],
  "summary": "一句话总结"
}
```

**使用技巧**：
- 提供完整的 JSON 模板示例
- 明确每个字段的含义和取值范围
- 说明是否允许空值或可选字段

```
输出格式要求：
以有效的 JSON 格式输出，请确保：
- 所有字符串使用双引号
- 数值类型不使用引号
- 数组可以为空但不能省略
- 字段名使用 snake_case 命名
```

#### 2. Markdown 格式

适合生成文档、报告等需要阅读的内容。

```
请使用以下 Markdown 格式输出：

# 主标题

## 1. 第一部分
[内容]

## 2. 第二部分
- 要点一
- 要点二
- 要点三

## 3. 总结
[总结段落]

| 列1 | 列2 | 列3 |
|-----|-----|-----|
| 数据 | 数据 | 数据 |
```

#### 3. 表格格式

适合对比和罗列信息。

```
请以表格形式输出，包含以下列：
| 功能名称 | 描述 | 优先级(P0-P3) | 预计工时 |
```

使用 Markdown 表格或 CSV 格式都可以：

```
CSV 格式输出：
功能名称,描述,优先级,预计工时
"用户登录","支持邮箱和手机号登录",P0,3天
...
```

#### 4. 列表格式

适合罗列要点、步骤等。

```
请以编号列表形式输出实施步骤，每个步骤包含：
1. **步骤名称**
   - 具体操作
   - 预期结果
   - 注意事项
```

#### 5. XML 格式

适合层级结构复杂的数据。

```
请以 XML 格式输出：
<analysis>
  <summary>总结内容</summary>
  <findings>
    <finding priority="high">发现1</finding>
    <finding priority="medium">发现2</finding>
  </findings>
  <recommendations>
    <item>建议1</item>
    <item>建议2</item>
  </recommendations>
</analysis>
```

### 3.4.3 格式约束的设计方法

#### 明确结构模板

提供具体的模板，而非抽象的描述：


- **目的**：提供可复用的提示词/模板，便于直接迁移到业务任务。
- **输入**：给模型的提示词/参数/上下文（必要时说明变量）。
- **输出**：期望输出格式或评价要点（最好给结构/示例）。
- **注意**（可选）：Token 成本、注入风险、以及常见失败点。

```
❌ 抽象描述：
输出一个包含标题、正文和结论的报告。

✓ 具体模板：
请按以下模板格式输出报告：

---
标题：[简洁的标题，不超过15字]

摘要：
[100字以内的核心观点概述]

正文：
[200-300字的详细分析]

结论与建议：
1. [第一条建议]
2. [第二条建议]
---
```

#### 指定长度限制

对各部分的长度设置明确的约束：

```
输出要求：
- 标题：10字以内
- 导语：50字以内
- 正文：每段100-150字，共3段
- 结语：30字以内
- 总字数控制在500字左右
```

#### 定义取值范围

对于特定字段，明确允许的取值：

```
输出字段说明：
- priority: 只能是 "high", "medium", "low" 之一
- score: 1-5 的整数
- status: "pending", "approved", "rejected" 之一
- date: 格式为 YYYY-MM-DD
```

### 3.4.4 高级格式控制技巧

#### 预填充技术

通过预填充回复的开头来强制输出格式（特别适用于 Claude）：

````
用户：分析这段文本的情感倾向。
助手：```json
{"sentiment":
```
````

通过预填充 JSON 开头，引导模型继续以 JSON 格式输出。

#### 格式验证提示

要求模型输出后进行自我验证：

```
请以 JSON 格式输出结果。
输出后，检查 JSON 是否有效，如果发现格式错误，请修正后重新输出。
```

#### 结构化思维与输出分离

区分思考过程和最终输出：

```
处理方式：
1. 在 <thinking> 标签内进行分析思考
2. 在 <output> 标签内提供最终结果

最终结果必须是有效的 JSON，不包含任何解释性文字。

请开始处理：
```

### 3.4.5 特殊格式需求

#### 代码输出

指定编程语言和代码块格式：

````
请输出 Python 代码，要求：
- 使用 ```python 代码块包裹
- 包含必要的注释
- 符合 PEP 8 规范
- 包含使用示例

示例格式：
```python
def example_function(param: str) -> dict:
    """
    函数说明
    
    Args:
        param: 参数说明
    
    Returns:
        返回值说明
    """
    # 实现代码
    pass

# 使用示例
result = example_function("test")
```
````

#### 多部分输出

当需要多个输出部分时，清晰分隔：

```
请输出以下三个部分，用 === 分隔：

第一部分：摘要（50字以内）
===
第二部分：详细分析（200字）
===
第三部分：JSON格式的结构化数据
```

#### 条件格式

根据不同情况使用不同格式：

```
输出格式要求：
- 如果找到匹配结果：输出 JSON 格式的详细信息
- 如果未找到结果：输出 "未找到匹配项：" + 原因说明
- 如果发生错误：输出 "处理错误：" + 错误描述
```

### 3.4.6 格式一致性保障

#### 使用示例强化

提供完整的输出示例：

```
输入示例：
"这个产品太贵了，质量还行"

期望输出：
{
  "text": "这个产品太贵了，质量还行",
  "aspects": [
    {"aspect": "价格", "sentiment": "negative"},
    {"aspect": "质量", "sentiment": "positive"}
  ],
  "overall": "mixed"
}

现在请处理以下输入：
"送货很快，包装也完好"
```

#### 格式检查清单

在提示词末尾添加检查提醒：

```
输出前请确认：
□ JSON 格式有效，可以被解析
□ 所有必填字段都已包含
□ 数值在规定范围内
□ 不包含额外的解释性文字
```

### 3.4.7 常见问题处理

#### 问题1：输出包含多余内容

```
问题：模型在 JSON 前后添加解释文字
解决：
明确要求：只输出 JSON，不要包含任何其他文字、解释或代码块标记。
或使用预填充技术。
```

#### 问题2：格式不完全符合要求

```
问题：输出的 JSON 字段名与要求不一致
解决：
提供精确的模板，强调字段名必须完全一致：
"字段名必须严格按照示例，包括大小写"
```

#### 问题3：嵌套结构错误

```
问题：复杂的嵌套 JSON 结构容易出错
解决：
1. 简化结构设计
2. 分步骤生成复杂结构
3. 提供完整的正确示例
```


### 想一想

1. JSON 和 Markdown 是两种常见的输出格式。在什么场景下你会选择一种而非另一种？
2. 如果你要求模型输出严格格式（如 JSON Schema），但模型偶尔不遵守，你有哪些应对手段？
