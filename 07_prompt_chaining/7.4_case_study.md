# 第七章：提示词链与任务分解

## 7.4 实战案例：构建多步骤工作流

本节通过一个完整的实战案例，展示如何设计和实现一个多步骤的提示词链工作流。

### 案例背景

**场景**：构建一个"竞品分析报告生成器"，能够根据输入的产品名称和竞品信息，自动生成结构化的竞品分析报告。

**输入**：
- 目标产品：产品名称和基本信息
- 竞品列表：2-3个竞争对手产品

**输出**：
- 结构化的竞品分析报告（Markdown格式）

### 任务分解

经过分析，将任务分解为以下步骤：

```
┌─────────────┐
│ 1. 信息整理  │
└──────┬──────┘
       ▼
┌─────────────┐      ┌─────────────┐
│ 2. 功能对比  │ ←──► │ 3. 定价分析  │  (并行)
└──────┬──────┘      └──────┬──────┘
       └────────┬──────────┘
                ▼
       ┌─────────────┐
       │ 4. SWOT分析  │
       └──────┬──────┘
              ▼
       ┌─────────────┐
       │ 5. 报告生成  │
       └──────┬──────┘
              ▼
       ┌─────────────┐
       │ 6. 质量检查  │
       └─────────────┘
```

### 各步骤提示词设计

#### 步骤1：信息整理

```markdown
# 步骤1：信息整理

你是一位产品分析师。请整理以下产品信息，提取关键属性。

## 输入信息
{raw_product_info}

## 任务
1. 提取每个产品的核心属性：
   - 产品名称
   - 所属公司
   - 产品定位
   - 核心功能（3-5个）
   - 目标用户
   - 定价模式

2. 以JSON格式输出整理后的结构化信息

## 输出格式
```json
{
  "target_product": {...},
  "competitors": [...]
}
```
```

#### 步骤2：功能对比

```markdown
# 步骤2：功能对比分析

你是一位产品功能专家。基于整理的产品信息，进行功能对比。

## 产品信息
{step1_output}

## 任务
1. 列出所有产品提及的功能点
2. 创建功能对比矩阵
3. 分析目标产品的功能优势和劣势

## 输出格式
```json
{
  "feature_matrix": [...],
  "target_advantages": [...],
  "target_disadvantages": [...],
  "analysis_summary": "..."
}
```
```

#### 步骤3：定价分析

```markdown
# 步骤3：定价分析

你是一位定价策略专家。分析各产品的定价策略。

## 产品信息
{step1_output}

## 任务
1. 整理各产品的定价信息
2. 分析定价策略差异
3. 评估目标产品的价格竞争力

## 输出格式
```json
{
  "pricing_comparison": [...],
  "pricing_strategy_analysis": "...",
  "price_competitiveness": "..."
}
```
```

#### 步骤4：SWOT分析

```markdown
# 步骤4：SWOT分析

你是一位战略分析师。基于前面的分析，为目标产品进行SWOT分析。

## 功能对比结果
{step2_output}

## 定价分析结果
{step3_output}

## 任务
对目标产品进行SWOT分析：
- Strengths（优势）：产品的内部优势
- Weaknesses（劣势）：产品的内部劣势
- Opportunities（机会）：外部市场机会
- Threats（威胁）：外部竞争威胁

## 输出格式
```json
{
  "strengths": [...],
  "weaknesses": [...],
  "opportunities": [...],
  "threats": [...]
}
```
```

#### 步骤5：报告生成

```markdown
# 步骤5：综合报告生成

你是一位资深分析师，擅长撰写专业的竞品分析报告。

## 分析数据

### 产品信息
{step1_output}

### 功能对比
{step2_output}

### 定价分析
{step3_output}

### SWOT分析
{step4_output}

## 任务
基于以上分析结果，生成一份完整的竞品分析报告。

## 报告结构
1. 执行摘要（200字以内）
2. 竞品概览（表格形式）
3. 功能对比分析
4. 定价策略对比
5. SWOT分析
6. 战略建议（3-5条）

## 格式要求
- 使用Markdown格式
- 使用表格呈现对比数据
- 语言专业简洁
```

#### 步骤6：质量检查

```markdown
# 步骤6：报告质量检查

你是一位资深编辑。请审核以下竞品分析报告。

## 报告内容
{step5_output}

## 检查项目
1. 结构完整性：是否包含所有必需章节？
2. 内容一致性：各部分数据是否一致？
3. 逻辑连贯性：分析逻辑是否清晰？
4. 格式规范性：Markdown格式是否正确？
5. 语言质量：是否有语病或不专业表达？

## 输出格式
```json
{
  "quality_score": 1-10,
  "issues_found": [...],
  "suggestions": [...],
  "approved": true/false
}
```

如果approved为false，请说明需要修改的地方。
```

### 工作流实现框架

```python
class CompetitorAnalysisWorkflow:
    
    def __init__(self, llm_client):
        self.llm = llm_client
        
    def run(self, product_info):
        # 步骤1：信息整理
        step1_result = self.execute_step(
            "信息整理",
            STEP1_PROMPT.format(raw_product_info=product_info)
        )
        
        # 步骤2和3：并行执行
        step2_result = self.execute_step(
            "功能对比",
            STEP2_PROMPT.format(step1_output=step1_result)
        )
        step3_result = self.execute_step(
            "定价分析",
            STEP3_PROMPT.format(step1_output=step1_result)
        )
        
        # 步骤4：SWOT分析
        step4_result = self.execute_step(
            "SWOT分析",
            STEP4_PROMPT.format(
                step2_output=step2_result,
                step3_output=step3_result
            )
        )
        
        # 步骤5：报告生成
        step5_result = self.execute_step(
            "报告生成",
            STEP5_PROMPT.format(
                step1_output=step1_result,
                step2_output=step2_result,
                step3_output=step3_result,
                step4_output=step4_result
            )
        )
        
        # 步骤6：质量检查（带重试）
        final_report = self.quality_check_with_retry(step5_result)
        
        return final_report
    
    def execute_step(self, step_name, prompt):
        print(f"执行步骤: {step_name}")
        response = self.llm.generate(prompt)
        return response
    
    def quality_check_with_retry(self, report, max_retries=2):
        for attempt in range(max_retries + 1):
            check_result = self.execute_step(
                "质量检查",
                STEP6_PROMPT.format(step5_output=report)
            )
            
            if check_result.get("approved", False):
                return report
            
            # 如果未通过，进行修正
            report = self.revise_report(
                report, 
                check_result.get("suggestions", [])
            )
        
        return report
```

### 关键实现细节

1. **错误处理**：每个步骤添加try-catch，记录错误并决定是否继续

2. **超时控制**：为每个步骤设置合理的超时时间

3. **结果验证**：解析JSON输出时验证格式正确性

4. **日志记录**：记录每个步骤的输入输出，便于调试

### 小结

本案例展示了如何将一个复杂的报告生成任务分解为多个专注的步骤，并通过提示词链串联起来。关键要点包括：合理的任务分解、清晰的步骤接口、有效的上下文传递，以及必要的质量检查机制。

### 延伸阅读

- [LangChain Chains](https://python.langchain.com/docs/concepts/chains/) - LangChain 链式调用
- [Least-to-Most Prompting](https://arxiv.org/abs/2205.10625) - 任务分解策略论文
